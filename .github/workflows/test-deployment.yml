name: ğŸ§ª Test Auto-Deploy

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/test-deployment.yml'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of deployment test'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - backend-only
        - frontend-only

jobs:
  pre-deploy-test:
    name: ğŸ” Pre-Deploy Validation
    runs-on: ubuntu-latest
    
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: ğŸ” Detect changes
        id: changes
        run: |
          echo "Detecting changes in last commit..."
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^backend/"; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No backend changes"
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No frontend changes"
          fi
          
      - name: ğŸ“Š Change Summary
        run: |
          echo "ğŸ“‹ Deployment Plan:"
          echo "Backend changes: ${{ steps.changes.outputs.backend }}"
          echo "Frontend changes: ${{ steps.changes.outputs.frontend }}"
          echo "Test type: ${{ github.event.inputs.test_type || 'auto' }}"

  test-backend-deploy:
    name: ğŸš€ Test Backend Auto-Deploy
    needs: pre-deploy-test
    runs-on: ubuntu-latest
    if: needs.pre-deploy-test.outputs.backend-changed == 'true' || github.event.inputs.test_type == 'backend-only' || github.event.inputs.test_type == 'full'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
          
      - name: ğŸ“¦ Install dependencies
        run: cd backend && npm ci
        
      - name: ğŸ§ª Quick test before deploy
        run: |
          cd backend
          echo "Testing backend before deployment..."
          node -c index.js
          echo "âœ… Backend syntax check passed"
          
      - name: ğŸš€ Simulate Deploy Trigger
        run: |
          echo "ğŸ¯ Triggering backend deployment..."
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ”— Render should detect this push and start deploying"
          echo "ğŸ“Š Monitor at: https://dashboard.render.com"
          
      - name: â³ Wait for Deploy Start
        run: |
          echo "â³ Waiting 60 seconds for deployment to initialize..."
          sleep 60
          echo "âœ… Deployment should be starting now"

  test-frontend-deploy:
    name: ğŸ¨ Test Frontend Auto-Deploy  
    needs: pre-deploy-test
    runs-on: ubuntu-latest
    if: needs.pre-deploy-test.outputs.frontend-changed == 'true' || github.event.inputs.test_type == 'frontend-only' || github.event.inputs.test_type == 'full'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: âš›ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: ğŸ“¦ Install dependencies
        run: cd frontend && npm ci
        
      - name: ğŸ—ï¸ Test build
        run: |
          cd frontend
          echo "Testing frontend build..."
          npm run build
          echo "âœ… Frontend build successful"
          
      - name: ğŸš€ Simulate Deploy Trigger
        run: |
          echo "ğŸ¯ Triggering frontend deployment..."
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ”— Render should detect this push and start deploying"
          echo "ğŸ“Š Monitor at: https://dashboard.render.com"

  post-deploy-validation:
    name: âœ… Post-Deploy Validation
    needs: [test-backend-deploy, test-frontend-deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Status
        run: |
          echo "ğŸ¯ Auto-Deploy Test Summary:"
          echo "================================"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ“‹ Jobs Status:"
          echo "Backend Deploy: ${{ needs.test-backend-deploy.result }}"
          echo "Frontend Deploy: ${{ needs.test-frontend-deploy.result }}"
          echo ""
          echo "ğŸ”— Next Steps:"
          echo "1. Check Render dashboard for actual deployment status"
          echo "2. Test deployed endpoints manually"
          echo "3. Verify auto-deploy is working correctly"
          echo ""
          echo "ğŸ“Š Render Dashboard: https://dashboard.render.com"
